rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================
    // HELPERS B√ÅSICOS
    // ==========================================
    function signedIn() {
      return request.auth != null;
    }

    function me() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function meExists() {
      return signedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

   function hasFuncao(f) { 
      return meExists() &&
        me().tipo == "DIRIGENTE" && 
         ('funcoes' in me()) && 
         me().funcoes.hasAny([f]); 
}

    function isChefeAgrupamento() { return hasFuncao("CHEFE_AGRUPAMENTO"); }
    function isSecretarioAgrupamento() { return hasFuncao("SECRETARIO_AGRUPAMENTO"); }
    function isChefeUnidade() { return hasFuncao("CHEFE_UNIDADE"); }
    function isDirigente() { return meExists() && me().tipo == "DIRIGENTE"; }

    function isGuiaOuSubGuia(){
      return meExists() && 
         me().tipo == "ELEMENTO" && 
         (
           ('isGuia' in me() && me().isGuia == true) || 
           ('isSubGuia' in me() && me().isSubGuia == true)
         );
}

    function sameAgrupamento(targetData) {
      return meExists() && targetData.agrupamentoId == me().agrupamentoId;
    }

    function sameSecao(targetData) {
      return sameAgrupamento(targetData) && targetData.secaoDocId == me().secaoDocId;
    }

    function sameSubunidade(targetData) {
      return sameSecao(targetData) 
        && targetData.patrulhaId != null 
        && targetData.patrulhaId == me().patrulhaId;
    }

    // ==========================================
    // COLE√á√ÉO: USERS
    // ==========================================
    match /users/{uid} {
      
      // üö® ALTERA√á√ÉO CR√çTICA: Permite pesquisa global por NIN para transfer√™ncias
      allow read: if signedIn();

      allow update: if signedIn() && (
        (request.auth.uid == uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['updatedAt', 'forcarMudancaPassword']))
        || (isChefeUnidade() && sameSecao(resource.data) && resource.data.ativo != false && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['patrulhaId', 'etapaProgresso', 'isGuia', 'isSubGuia', 'totem', 'updatedAt']))
        || (isChefeAgrupamento() && sameAgrupamento(resource.data) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['secaoDocId', 'tipo', 'funcoes', 'totem', 'updatedAt']))
      );

      match /objetivos/{oid} {
        allow read: if signedIn() && (request.auth.uid == uid || isChefeAgrupamento() || isDirigente() || isGuiaOuSubGuia());
        allow create: if signedIn() && (request.auth.uid == uid || isChefeUnidade());
        allow delete: if signedIn() && (request.auth.uid == uid || isChefeUnidade());
        allow update: if signedIn() && (isGuiaOuSubGuia() || isChefeUnidade());
      }

      match /meta/{docId} {
        allow read, write: if signedIn() && request.auth.uid == uid;
      }
    }

    // ==========================================
    // COLE√á√ÉO: NOTIFICA√á√ïES (ORDEM DE SERVI√áO)
    // ==========================================
    match /notificacoes/{nid} {
      allow read: if signedIn() && (isSecretarioAgrupamento() || isChefeAgrupamento()) && resource.data.agrupamentoId == me().agrupamentoId;
      
      // üö® PERMITE √Ä SECRETARIA CRIAR NOTIFICA√á√ïES DE "SAIU/VOLTOU AO ATIVO"
      allow create: if signedIn() && (isSecretarioAgrupamento() || isChefeAgrupamento() || isDirigente() || isChefeUnidade());

      allow update: if signedIn() && (isSecretarioAgrupamento() || isChefeAgrupamento())
        && sameAgrupamento(resource.data)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['resolvida', 'resolvidaAt', 'resolvidaPorUid']);
    }

    match /agrupamento/{agrupamentoId} {
      allow read: if signedIn() && me().agrupamentoId == agrupamentoId;
      match /secoes/{secaoId} {
        allow read: if signedIn() && me().agrupamentoId == agrupamentoId;
        allow write: if signedIn() && isChefeUnidade() && me().secaoDocId == secaoId;
        match /subunidades/{sid} {
          allow read: if signedIn() && me().agrupamentoId == agrupamentoId;
          allow write: if signedIn() && isChefeUnidade() && me().secaoDocId == secaoId;
        }
      }
    }

    match /catalogoObjetivos/{document=**} {
      allow read: if signedIn();
    }
  
    // ==========================================
    // COLE√á√ÉO: OPORTUNIDADES (OBJETIVOS NACIONAIS E AGRUPAMENTO)
    // ==========================================

    // Objetivos Nacionais (Sincronizados via XML pelo Secret√°rio)
    match /oportunidades_cne/{id} {
      allow read: if signedIn();
      allow write: if signedIn() && isSecretarioAgrupamento();
    }

    // Oportunidades criadas pelo pr√≥prio Agrupamento
    match /oportunidades_agrupamento/{id} {
      allow read: if signedIn() && sameAgrupamento(resource.data);
      // SA, CA e CU podem gerir as oportunidades locais
      allow write: if signedIn() && (isSecretarioAgrupamento() || isChefeAgrupamento() || isChefeUnidade());
    }

    // Oportunidades Ocultas ou Arquivadas
    match /oportunidades_ocultas/{id} {
      allow read: if signedIn() && sameAgrupamento(resource.data);
      allow write: if signedIn() && (isSecretarioAgrupamento() || isChefeAgrupamento() || isChefeUnidade());
    }

    // Recursos Oficiais (CNE)
    match /recursos_oficiais_cne/{id} {
      allow read: if signedIn();
      allow write: if signedIn() && isSecretarioAgrupamento();
    }
  }
}