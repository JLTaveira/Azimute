rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================
    // HELPERS B√ÅSICOS
    // ==========================================
    function signedIn() {
      return request.auth != null;
    }

    function me() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function meExists() {
      return signedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

   function hasFuncao(f) { 
      return meExists() &&
        me().tipo == "DIRIGENTE" && 
         ('funcoes' in me()) && 
         me().funcoes.hasAny([f]); 
    }

    function isChefeAgrupamento() { return hasFuncao("CHEFE_AGRUPAMENTO"); }
    function isSecretarioAgrupamento() { return hasFuncao("SECRETARIO_AGRUPAMENTO"); }
    function isChefeUnidade() { return hasFuncao("CHEFE_UNIDADE"); }
    function isDirigente() { return meExists() && me().tipo == "DIRIGENTE"; }

    function isGuiaOuSubGuia(){
      return meExists() && 
         me().tipo == "ELEMENTO" && 
         (
           ('isGuia' in me() && me().isGuia == true) || 
           ('isSubGuia' in me() && me().isSubGuia == true)
         );
    }

    function sameAgrupamento(targetData) {
      return meExists() && targetData.agrupamentoId == me().agrupamentoId;
    }

    function sameSecao(targetData) {
      return sameAgrupamento(targetData) && targetData.secaoDocId == me().secaoDocId;
    }

    function sameSubunidade(targetData) {
      return sameSecao(targetData) 
        && targetData.patrulhaId != null 
        && targetData.patrulhaId == me().patrulhaId;
    }

    // ==========================================
    // COLE√á√ÉO: USERS
    // ==========================================
    match /users/{uid} {
      
      // üö® ALTERA√á√ÉO CR√çTICA: Permite pesquisa global por NIN para transfer√™ncias
      allow read: if signedIn();

      allow update: if signedIn() && (
        (request.auth.uid == uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['updatedAt', 'forcarMudancaPassword']))
        || (isChefeUnidade() && sameSecao(resource.data) && resource.data.ativo != false && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['patrulhaId', 'etapaProgresso', 'isGuia', 'isSubGuia', 'totem', 'updatedAt']))
        || (isChefeAgrupamento() && sameAgrupamento(resource.data) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['secaoDocId', 'tipo', 'funcoes', 'totem', 'updatedAt']))
      );

      match /objetivos/{oid} {
        allow read: if signedIn() && (request.auth.uid == uid || isChefeAgrupamento() || isDirigente() || isGuiaOuSubGuia());
        allow create, delete: if signedIn() && (request.auth.uid == uid || isChefeUnidade());
        // O elemento (request.auth.uid == uid) j√° est√° aqui, isto est√° correto.
        allow update: if signedIn() && (request.auth.uid == uid || isGuiaOuSubGuia() || isChefeUnidade());
      }

      match /meta/{docId} {
        allow read, write: if signedIn() && request.auth.uid == uid;
      }
    }

    // ==========================================
    // COLE√á√ÉO: NOTIFICA√á√ïES (Mistas: O.S. e Felicita√ß√µes)
    // ==========================================
    match /notificacoes/{nid} {
      // LEITURA: 
      // 1. Chefia pode ler notifica√ß√µes do seu agrupamento (O.S. e Anilhas)
      // 2. Elementos podem ler se o seu UID estiver no campo uidElemento (Felicita√ß√µes)
      allow read: if signedIn() && (
        ( (isSecretarioAgrupamento() || isChefeAgrupamento()) && resource.data.agrupamentoId == me().agrupamentoId ) 
        || 
        ( resource.data.uidElemento == request.auth.uid )
      );
      
      // CRIA√á√ÉO: Qualquer Dirigente/Chefe pode criar (Avisa Secretaria, Felicita√ß√µes)
      allow create: if signedIn() && (isSecretarioAgrupamento() || isChefeAgrupamento() || isDirigente() || isChefeUnidade());

      // UPDATE: 
      // 1. Elementos podem marcar as suas felicita√ß√µes como lidas
      // 2. Chefia pode marcar O.S. como resolvidas
      allow update: if signedIn() && (
        ( resource.data.uidElemento == request.auth.uid )
        || 
        ( (isSecretarioAgrupamento() || isChefeAgrupamento()) && sameAgrupamento(resource.data) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['resolvida', 'resolvidaAt', 'resolvidaPorUid']) )
      );
      
      // Escrita total para Chefes se for preciso apagar
      allow write: if signedIn() && isDirigente();
    }

    match /agrupamento/{agrupamentoId} {
      allow read: if signedIn() && me().agrupamentoId == agrupamentoId;
      match /secoes/{secaoId} {
        allow read: if signedIn() && me().agrupamentoId == agrupamentoId;
        allow write: if signedIn() && isChefeUnidade() && me().secaoDocId == secaoId;
        match /subunidades/{sid} {
          allow read: if signedIn() && me().agrupamentoId == agrupamentoId;
          allow write: if signedIn() && isChefeUnidade() && me().secaoDocId == secaoId;
        }
      }
    }

    match /catalogoObjetivos/{document=**} {
      allow read: if signedIn();
    }
  
    // ==========================================
    // COLE√á√ÉO: OPORTUNIDADES (OBJETIVOS NACIONAIS E AGRUPAMENTO)
    // ==========================================

    match /oportunidades_cne/{id} {
      allow read: if signedIn();
      allow write: if signedIn() && isSecretarioAgrupamento();
    }

    match /oportunidades_agrupamento/{id} {
      allow read: if signedIn() && sameAgrupamento(resource.data);
      allow write: if signedIn() && (isSecretarioAgrupamento() || isChefeAgrupamento() || isChefeUnidade());
    }

    match /oportunidades_ocultas/{id} {
      allow read: if signedIn() && sameAgrupamento(resource.data);
      allow write: if signedIn() && (isSecretarioAgrupamento() || isChefeAgrupamento() || isChefeUnidade());
    }

    match /recursos_oficiais_cne/{id} {
      allow read: if signedIn();
      allow write: if signedIn() && isSecretarioAgrupamento();
    }
  } // FIM DO BLOCO /databases/{database}/documents
} // FIM DO SERVICE CLOUD.FIRESTORE