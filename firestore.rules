rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function me() { return get(/databases/$(database)/documents/users/$(request.auth.uid)).data; }
    function meExists() { return signedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid)); }
    function hasFuncao(f) { return meExists() && (f in me().funcoes); }

    // DEFINIÇÃO DE CARGOS
    function isChefeAgrupamento() { return hasFuncao("CHEFE_AGRUPAMENTO"); }
    function isAdjuntoAgrupamento() { return hasFuncao("CHEFE_AGRUPAMENTO_ADJUNTO"); }
    function isSecretarioAgrupamento() { return hasFuncao("SECRETARIO_AGRUPAMENTO"); }
    function isTesoureiro() { return hasFuncao("TESOUREIRO_AGRUPAMENTO"); }
    function isChefeUnidade() { return hasFuncao("CHEFE_UNIDADE"); }

    // Grupo de Direção (Leitura Total)
    function isDirecao() {
      return isChefeAgrupamento() || isAdjuntoAgrupamento() || isSecretarioAgrupamento() || isTesoureiro() || isChefeUnidade();
    }

    function sameAgrupamento(targetData) {
      return meExists() && targetData.agrupamentoId == me().agrupamentoId;
    }

    // --- REGRAS DE ESTRUTURA ---
    match /agrupamento/{agrupamentoId} {
      // Toda a Direção lê a estrutura do Agrupamento
      allow read: if signedIn() && me().agrupamentoId == agrupamentoId;

      match /secoes/{secaoId} {
        allow read: if signedIn() && me().agrupamentoId == agrupamentoId;
        // Escrita permitida se for Chefe desta Secção OU Chefe de Agrupamento
        allow write: if signedIn() && (
          isChefeAgrupamento() || 
          (isChefeUnidade() && me().secaoDocId == secaoId)
        );

        match /subunidades/{sid} {
          allow read: if signedIn() && me().agrupamentoId == agrupamentoId;
          allow write: if signedIn() && (
            isChefeAgrupamento() || 
            (isChefeUnidade() && me().secaoDocId == secaoId)
          );
        }
      }
    }

    match /users/{uid} {
      allow read: if signedIn();
      allow update: if signedIn() && (
        (request.auth.uid == uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['updatedAt', 'forcarMudancaPassword']))
        || (isChefeUnidade() && me().secaoDocId == resource.data.secaoDocId && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['patrulhaId', 'etapaProgresso', 'isGuia', 'isSubGuia', 'totem', 'updatedAt']))
        || (isChefeAgrupamento() && sameAgrupamento(resource.data))
      );
      
      match /arquivados/{docId} { allow read, write: if request.auth.uid == uid; }
    }

    match /notificacoes/{nid} {
      allow read: if signedIn() && isDirecao() && resource.data.agrupamentoId == me().agrupamentoId;
      allow create: if signedIn() && (isDirecao() || me().tipo == "DIRIGENTE");
      // Apenas cargos executivos confirmam OS
      allow update: if signedIn() && (isSecretarioAgrupamento() || isChefeAgrupamento()) && sameAgrupamento(resource.data);
    }

    // Regras de Oportunidades (SA, CA e CU escrevem e arquivam)
    match /oportunidades_agrupamento/{id} {
      allow read: if signedIn();
      allow write: if signedIn() && (isSecretarioAgrupamento() || isChefeAgrupamento() || isChefeUnidade());
    }
    match /oportunidades_ocultas/{id} {
      allow read, write: if signedIn() && (isSecretarioAgrupamento() || isChefeAgrupamento());
    }
    
    match /oportunidades_cne/{id} { allow read: if signedIn(); }
    match /catalogoObjetivos/{document=**} { allow read: if signedIn(); }
  }
}